// **************************************************************************
// **************************************************************************
// **************************************************************************
// **                                                                      **
// ** BITIO.C                                                       MODULE **
// **                                                                      **
// ** Functions to provide bitwise stream-I/O to a RAM resident structure. **
// **                                                                      **
// ** Last modified : 06 Nov 1996 by John Brandwood                        **
// **                                                                      **
// **************************************************************************
// **************************************************************************
// **************************************************************************

#include	<stddef.h>

#include	"elmer.h"
#include	"bitio.h"

//
// DEFINITIONS
//

//
// GLOBAL VARIABLES
//

//
// STATIC VARIABLES
//

static	UB                  ub___BitRack;
static	UB                  ub___BitMask;

//
// STATIC FUNCTION PROTOTYPES
//



// **************************************************************************
// **************************************************************************
// **************************************************************************
//	GLOBAL FUNCTIONS
// **************************************************************************
// **************************************************************************
// **************************************************************************



// **************************************************************************
// * BitIOInit ()                                                           *
// **************************************************************************
// * Initialize bit-oriented buffered output                                *
// **************************************************************************
// * Inputs  UB *    Ptr to output buffer                                   *
// *                                                                        *
// * Output  UB *    Ptr to next free byte in the output buffer             *
// **************************************************************************

global	UB * BitIOInit (UB * pub__dst)

	{
	// Initialize the vars.

	ub___BitRack = 0x00u;
	ub___BitMask = 0x80u;

	// Return with success.

	return (pub__dst);
	}



// **************************************************************************
// * BitIOWrite ()                                                          *
// **************************************************************************
// * Write to bit-oriented buffered output                                  *
// **************************************************************************
// * Inputs  UB *    Ptr to output buffer                                   *
// *         UI      Bit data to write                                      *
// *         UI      # of bits to write                                     *
// *                                                                        *
// * Output  UB *    Ptr to next free byte in the output buffer             *
// **************************************************************************

global	UB * BitIOWrite (UB * pub__dst, UI ui___bitstream, UI ui___bitcount)

	{
	// Local Variables.

	UI                  ui___bitmask;

	//

	if (ui___bitcount != 0)
		{
		ui___bitmask = 1 << (ui___bitcount - 1);

		while (ui___bitmask != 0)
			{
			if (ui___bitmask & ui___bitstream) {
				ub___BitRack |= ub___BitMask;
				}

			ub___BitMask >>= 1;

			if (ub___BitMask == 0) {
				*pub__dst++ = ub___BitRack;
				ub___BitRack = 0x00u;
				ub___BitMask = 0x80u;
				}

			ui___bitmask >>= 1;
			}
		}

	// Return with success.

	return (pub__dst);
	}



// **************************************************************************
// * BitIOFlush ()                                                          *
// **************************************************************************
// * Flush bit-oriented buffered output                                     *
// **************************************************************************
// * Inputs  UB *    Ptr to output buffer                                   *
// *                                                                        *
// * Output  UB *    Ptr to next free byte in the output buffer             *
// **************************************************************************

global	UB * BitIOFlush (UB * pub__dst, FL fl___align)

	{
	//

	if (ub___BitMask != 0x80u)
		{
		*pub__dst++  = ub___BitRack;
		ub___BitRack = 0x00u;
		ub___BitMask = 0x80u;
		}

	if (fl___align)
		{
		while (((UL) pub__dst) & 3)
			{
			*pub__dst++ = 0;
			}
		}

	// Return with success.

	return (pub__dst);
	}



// **************************************************************************
// **************************************************************************
// **************************************************************************
//	END OF BITIO.C
// **************************************************************************
// **************************************************************************
// **************************************************************************

